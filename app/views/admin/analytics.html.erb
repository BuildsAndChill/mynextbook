<div class="min-h-screen bg-gray-50 py-8">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <!-- Header -->
    <div class="mb-8">
      <h1 class="text-3xl font-bold text-gray-900">Analytics Dashboard</h1>
      <p class="mt-2 text-gray-600">Analyse compl√®te des performances et du comportement utilisateur</p>
    </div>

    <!-- Navigation Admin -->
    <div class="mb-8">
      <div class="flex justify-between items-center">
        <nav class="flex space-x-4">
          <%= link_to "Dashboard", admin_dashboard_path, class: "px-3 py-2 rounded-md text-sm font-medium text-gray-700 hover:text-gray-900 hover:bg-gray-100" %>
          <%= link_to "Tracking", admin_tracking_index_path, class: "px-3 py-2 rounded-md text-sm font-medium text-gray-700 hover:text-gray-900 hover:bg-gray-100" %>
          <%= link_to "Subscribers", admin_subscribers_path, class: "px-3 py-2 rounded-md text-sm font-medium text-gray-700 hover:text-gray-900 hover:bg-gray-100" %>
          <%= link_to "Users", admin_users_path, class: "px-3 py-2 rounded-md text-sm font-medium text-gray-700 hover:text-gray-900 hover:bg-gray-100" %>
          <%= link_to "Analytics", admin_analytics_path, class: "px-3 py-2 rounded-md text-sm font-medium bg-indigo-100 text-indigo-700" %>
        </nav>
        
        <!-- Bouton Refresh Analytics -->
        <div class="flex items-center space-x-2">
          <span class="text-sm text-gray-500">Cache: 1h</span>
          <%= link_to admin_refresh_analytics_path, 
                      class: "inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50",
                      data: { turbo_method: :get } do %>
            <svg class="h-4 w-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
            </svg>
            Actualiser
          <% end %>
        </div>
      </div>
    </div>

    <!-- KPIs Overview -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
      <!-- Total Sessions -->
      <div class="bg-white overflow-hidden shadow rounded-lg">
        <div class="p-5">
          <div class="flex items-center">
            <div class="flex-shrink-0">
              <svg class="h-6 w-6 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
              </svg>
            </div>
            <div class="ml-5 w-0 flex-1">
              <dl>
                <dt class="text-sm font-medium text-gray-500 truncate">Sessions Totales</dt>
                <dd class="text-lg font-medium text-gray-900"><%= @recommendation_stats[:total_sessions] %></dd>
              </dl>
            </div>
          </div>
        </div>
      </div>

      <!-- Total Subscribers -->
      <div class="bg-white overflow-hidden shadow rounded-lg">
        <div class="p-5">
          <div class="flex items-center">
            <div class="flex-shrink-0">
              <svg class="h-6 w-6 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
              </svg>
            </div>
            <div class="ml-5 w-0 flex-1">
              <dl>
                <dt class="text-sm font-medium text-gray-500 truncate">Subscribers</dt>
                <dd class="text-lg font-medium text-gray-900"><%= @email_capture_stats[:total] %></dd>
              </dl>
            </div>
          </div>
        </div>
      </div>

      <!-- Total Users -->
      <div class="bg-white overflow-hidden shadow rounded-lg">
        <div class="p-5">
          <div class="flex items-center">
            <div class="flex-shrink-0">
              <svg class="h-6 w-6 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"></path>
              </svg>
            </div>
            <div class="ml-5 w-0 flex-1">
              <dl>
                <dt class="text-sm font-medium text-gray-500 truncate">Utilisateurs</dt>
                <dd class="text-lg font-medium text-gray-900"><%= @user_engagement_stats[:total_users] %></dd>
              </dl>
            </div>
          </div>
        </div>
      </div>

      <!-- Total Interactions -->
      <div class="bg-white overflow-hidden shadow rounded-lg">
        <div class="p-5">
          <div class="flex items-center">
            <div class="flex-shrink-0">
              <svg class="h-6 w-6 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
              </svg>
            </div>
            <div class="ml-5 w-0 flex-1">
              <dl>
                <dt class="text-sm font-medium text-gray-500 truncate">Interactions</dt>
                <dd class="text-lg font-medium text-gray-900"><%= Interaction.count %></dd>
              </dl>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Timeline des Sessions -->
    <div class="bg-white shadow rounded-lg mb-8">
      <div class="px-4 py-5 sm:p-6">
        <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Timeline des Sessions (30 derniers jours)</h3>
        <div class="h-64">
          <canvas id="sessionTimelineChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Croissance des Utilisateurs -->
    <div class="bg-white shadow rounded-lg mb-8">
      <div class="px-4 py-5 sm:p-6">
        <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Croissance des Utilisateurs (12 derniers mois)</h3>
        <div class="h-64">
          <canvas id="userGrowthChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Funnel de Conversion -->
    <div class="bg-white shadow rounded-lg mb-8">
      <div class="px-4 py-5 sm:p-6">
        <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Funnel de Conversion</h3>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
          <div class="text-center">
            <div class="text-2xl font-bold text-blue-600"><%= @conversion_funnel[:total_sessions] %></div>
            <div class="text-sm text-gray-600">Sessions</div>
          </div>
          <div class="text-center">
            <div class="text-2xl font-bold text-green-600"><%= @conversion_funnel[:sessions_with_interactions] %></div>
            <div class="text-sm text-gray-600">Avec Interactions</div>
            <div class="text-xs text-gray-500"><%= @conversion_funnel[:conversion_rates][:interactions] %>%</div>
          </div>
          <div class="text-center">
            <div class="text-2xl font-bold text-yellow-600"><%= @conversion_funnel[:sessions_with_emails] %></div>
            <div class="text-sm text-gray-600">Avec Emails</div>
            <div class="text-xs text-gray-500"><%= @conversion_funnel[:conversion_rates][:emails] %>%</div>
          </div>
          <div class="text-center">
            <div class="text-2xl font-bold text-purple-600"><%= @conversion_funnel[:sessions_with_users] %></div>
            <div class="text-sm text-gray-600">Utilisateurs</div>
            <div class="text-xs text-gray-500"><%= @conversion_funnel[:conversion_rates][:users] %>%</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Top Performers -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
      <!-- Top Sessions par Interactions -->
      <div class="bg-white shadow rounded-lg">
        <div class="px-4 py-5 sm:p-6">
          <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Top Sessions par Interactions</h3>
          <div class="space-y-3">
            <% @top_performers[:top_sessions_by_interactions].each_with_index do |(session_id, count), index| %>
              <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                <div class="flex items-center space-x-3">
                  <div class="flex-shrink-0">
                    <span class="inline-flex items-center justify-center h-8 w-8 rounded-full bg-indigo-100 text-indigo-800 text-sm font-medium">
                      <%= index + 1 %>
                    </span>
                  </div>
                  <div class="flex-1 min-w-0">
                    <p class="text-sm font-medium text-gray-900 truncate">
                      <%= session_id.first(8) %>...
                    </p>
                  </div>
                </div>
                <div class="ml-4 flex-shrink-0">
                  <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                    <%= count %> interactions
                  </span>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      </div>

      <!-- Top Contexts -->
      <div class="bg-white shadow rounded-lg">
        <div class="px-4 py-5 sm:p-6">
          <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Top Contexts de Recommandation</h3>
          <div class="space-y-3">
            <% @top_performers[:top_contexts].each_with_index do |(context, count), index| %>
              <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                <div class="flex items-center space-x-3">
                  <div class="flex-shrink-0">
                    <span class="inline-flex items-center justify-center h-8 w-8 rounded-full bg-purple-100 text-purple-800 text-sm font-medium">
                      <%= index + 1 %>
                    </span>
                  </div>
                  <div class="flex-1 min-w-0">
                    <p class="text-sm font-medium text-gray-900 truncate">
                      <%= context || 'Sans contexte' %>
                    </p>
                  </div>
                </div>
                <div class="ml-4 flex-shrink-0">
                  <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800">
                    <%= count %> recommandations
                  </span>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    </div>

    <!-- Heatmap des Interactions -->
    <div class="bg-white shadow rounded-lg mb-8">
      <div class="px-4 py-5 sm:p-6">
        <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Heatmap des Interactions (Heure vs Jour)</h3>
        
        <!-- L√©gende am√©lior√©e -->
        <div class="mb-6 flex flex-wrap items-center justify-between gap-4 p-4 bg-gray-50 rounded-lg border">
          <div class="flex flex-wrap items-center gap-6">
            <div class="flex items-center space-x-2">
              <div class="w-5 h-5 bg-gray-100 border-2 border-gray-300 rounded-md"></div>
              <span class="text-sm font-medium text-gray-700">0 interaction</span>
            </div>
            <div class="flex items-center space-x-2">
              <div class="w-5 h-5 bg-blue-200 border-2 border-gray-300 rounded-md"></div>
              <span class="text-sm font-medium text-gray-700">Faible (1-2)</span>
            </div>
            <div class="flex items-center space-x-2">
              <div class="w-5 h-5 bg-blue-400 border-2 border-gray-300 rounded-md"></div>
              <span class="text-sm font-medium text-gray-700">Moyen (3-5)</span>
            </div>
            <div class="flex items-center space-x-2">
              <div class="w-5 h-5 bg-blue-600 border-2 border-gray-300 rounded-md"></div>
              <span class="text-sm font-medium text-gray-700">√âlev√© (6+)</span>
            </div>
          </div>
          <div class="flex items-center space-x-2 text-sm text-gray-600">
            <svg class="w-4 h-4 text-yellow-500" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
            </svg>
            <span>Cliquez sur une cellule pour voir les d√©tails</span>
          </div>
        </div>
        
        <!-- Heatmap optimis√©e DESKTOP - structure corrig√©e -->
        <div class="w-full">
          <!-- Tableau de la heatmap avec structure correcte -->
          <table class="w-full border-collapse">
            <thead>
              <tr>
                <th class="w-24 h-12 text-sm font-semibold text-gray-700 text-center"></th>
                <th class="h-12 text-sm font-semibold text-gray-700 text-center">Dimanche</th>
                <th class="h-12 text-sm font-semibold text-gray-700 text-center">Lundi</th>
                <th class="h-12 text-sm font-semibold text-gray-700 text-center">Mardi</th>
                <th class="h-12 text-sm font-semibold text-gray-700 text-center">Mercredi</th>
                <th class="h-12 text-sm font-semibold text-gray-700 text-center">Jeudi</th>
                <th class="h-12 text-sm font-semibold text-gray-700 text-center">Vendredi</th>
                <th class="h-12 text-sm font-semibold text-gray-700 text-center">Samedi</th>
              </tr>
            </thead>
            <tbody>
              <% (0..23).each do |hour| %>
                <tr>
                  <!-- Label de l'heure -->
                  <td class="w-24 h-10 text-sm font-semibold text-gray-700 text-right pr-4 align-middle">
                    <%= hour %>h
                  </td>
                  
                  <!-- Cellules pour chaque jour -->
                  <% (0..6).each do |wday| %>
                    <% key = "#{hour}-#{wday}" %>
                    <% count = @interaction_heatmap[key] || 0 %>
                    <% 
                      # Calculer l'intensit√© de mani√®re plus intelligente
                      max_count = @interaction_heatmap.values.max || 1
                      intensity = if count > 0
                        # √âchelle de 0.2 √† 1.0 pour une meilleure visibilit√©
                        (count.to_f / max_count * 0.8 + 0.2)
                      else
                        0
                      end
                      
                      # Couleur de base et couleur de fond
                      bg_color = if count > 0
                        "rgba(59, 130, 246, #{intensity})"
                      else
                        "#f8fafc" # Gris tr√®s clair pour les cellules vides
                      end
                      
                      border_color = count > 0 ? "#3b82f6" : "#e2e8f0"
                    %>
                    <td class="h-10 p-1">
                      <div class="h-10 w-full rounded-lg border-2 transition-all duration-200 hover:border-blue-500 hover:shadow-lg cursor-pointer flex items-center justify-center" 
                           style="background-color: <%= bg_color %>; border-color: <%= border_color %>"
                           title="<%= hour %>h <%= Date::DAYNAMES[wday] %>: <%= count %> interactions">
                        <% if count > 0 %>
                          <span class="text-sm text-white font-bold leading-none drop-shadow-sm">
                            <%= count %>
                          </span>
                        <% end %>
                      </div>
                    </td>
                  <% end %>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
        
        <!-- Statistiques de la heatmap am√©lior√©es -->
        <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4">
          <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
            <div class="flex items-center">
              <div class="flex-shrink-0">
                <svg class="h-6 w-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                </svg>
              </div>
              <div class="ml-3">
                <p class="text-sm font-medium text-blue-900">Cellules actives</p>
                <p class="text-2xl font-bold text-blue-600">
                  <% total_cells = @interaction_heatmap.values.count { |v| v > 0 } %>
                  <%= total_cells %>
                </p>
                <p class="text-xs text-blue-700">sur 168 (24h √ó 7 jours)</p>
              </div>
            </div>
          </div>
          
          <div class="bg-green-50 p-4 rounded-lg border border-green-200">
            <div class="flex items-center">
              <div class="flex-shrink-0">
                <svg class="h-6 w-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                </svg>
              </div>
              <div class="ml-3">
                <p class="text-sm font-medium text-green-900">Pic d'activit√©</p>
                <p class="text-2xl font-bold text-green-600">
                  <% max_interactions = @interaction_heatmap.values.max || 0 %>
                  <%= max_interactions %>
                </p>
                <p class="text-xs text-green-700">interactions max</p>
              </div>
            </div>
          </div>
          
          <div class="bg-purple-50 p-4 rounded-lg border border-purple-200">
            <div class="flex items-center">
              <div class="flex-shrink-0">
                <svg class="h-6 w-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
              </div>
              <div class="ml-3">
                <p class="text-sm font-medium text-purple-900">Heures actives</p>
                <p class="text-2xl font-bold text-purple-600">
                  <% active_hours = @interaction_heatmap.keys.select { |k| @interaction_heatmap[k] > 0 }.map { |k| k.split('-')[0] }.uniq.count %>
                  <%= active_hours %>
                </p>
                <p class="text-xs text-purple-700">sur 24 heures</p>
              </div>
            </div>
          </div>
        </div>
        
        <% if total_cells == 0 %>
          <div class="mt-4 p-4 bg-amber-50 border border-amber-200 rounded-lg">
            <div class="flex">
              <div class="flex-shrink-0">
                <svg class="h-5 w-5 text-amber-400" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                </svg>
              </div>
              <div class="ml-3">
                <p class="text-sm text-amber-800">‚ö†Ô∏è Aucune interaction trouv√©e - affichage de donn√©es de test</p>
              </div>
            </div>
          </div>
        <% end %>
        
        <!-- Debug info (optionnel) -->
        <details class="mt-4 text-xs text-gray-500">
          <summary class="cursor-pointer hover:text-gray-700">üîç Debug: Voir les donn√©es brutes</summary>
          <div class="mt-2 p-2 bg-gray-50 rounded border font-mono text-xs overflow-auto max-h-32">
            <pre><%= JSON.pretty_generate(@interaction_heatmap) %></pre>
          </div>
        </details>
        
        <!-- Debug d√©taill√© des donn√©es -->
        <details class="mt-2 text-xs text-gray-500">
          <summary class="cursor-pointer hover:text-gray-700">üîç Debug: Analyse d√©taill√©e des donn√©es</summary>
          <div class="mt-2 p-2 bg-gray-50 rounded border font-mono text-xs overflow-auto max-h-48">
            <h4 class="font-bold mb-2">üìä Donn√©es de la heatmap:</h4>
            <% if @interaction_heatmap.present? %>
              <% total_cells = @interaction_heatmap.values.count { |v| v > 0 } %>
              <% max_interactions = @interaction_heatmap.values.max || 0 %>
              <p>Total cellules avec interactions: <strong><%= total_cells %></strong></p>
              <p>Pic d'activit√©: <strong><%= max_interactions %></strong> interactions</p>
              
              <h5 class="font-bold mt-3 mb-2">üî• Interactions par heure/jour:</h5>
              <% @interaction_heatmap.select { |_, v| v > 0 }.sort_by { |k, _| k }.each do |key, count| %>
                <% hour, wday = key.split('-') %>
                <% day_name = Date::DAYNAMES[wday.to_i] %>
                <p><%= key %> (<%= hour %>h <%= day_name %>): <strong><%= count %></strong> interactions</p>
              <% end %>
              
              <h5 class="font-bold mt-3 mb-2">üîç V√©rification des cl√©s:</h5>
              <% expected_keys = [] %>
              <% (0..23).each do |hour| %>
                <% (0..6).each do |wday| %>
                  <% expected_keys << "#{hour}-#{wday}" %>
                <% end %>
              <% end %>
              <% missing_keys = expected_keys - @interaction_heatmap.keys %>
              <p>Cl√©s attendues: <strong><%= expected_keys.count %></strong></p>
              <p>Cl√©s pr√©sentes: <strong><%= @interaction_heatmap.keys.count %></strong></p>
              <% if missing_keys.any? %>
                <p class="text-red-600">‚ùå Cl√©s manquantes: <%= missing_keys.first(5).join(', ') %><%= missing_keys.count > 5 ? '...' : '' %></p>
              <% else %>
                <p class="text-green-600">‚úÖ Toutes les cl√©s sont pr√©sentes</p>
              <% end %>
            <% else %>
              <p class="text-red-600">‚ùå @interaction_heatmap est nil ou vide</p>
            <% end %>
          </div>
        </details>
      </div>
    </div>
  </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Timeline des Sessions
  const timelineCtx = document.getElementById('sessionTimelineChart').getContext('2d');
  const timelineData = <%= raw @session_timeline.to_json %>;
  
  new Chart(timelineCtx, {
    type: 'line',
    data: {
      labels: timelineData.map(d => d.date),
      datasets: [
        {
          label: 'Sessions',
          data: timelineData.map(d => d.sessions),
          borderColor: 'rgb(59, 130, 246)',
          backgroundColor: 'rgba(59, 130, 246, 0.1)',
          tension: 0.4
        },
        {
          label: 'Interactions',
          data: timelineData.map(d => d.interactions),
          borderColor: 'rgb(16, 185, 129)',
          backgroundColor: 'rgba(16, 185, 129, 0.1)',
          tension: 0.4
        },
        {
          label: 'Nouveaux Subscribers',
          data: timelineData.map(d => d.new_subscribers),
          borderColor: 'rgb(245, 158, 11)',
          backgroundColor: 'rgba(245, 158, 11, 0.1)',
          tension: 0.4
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          beginAtZero: true
        }
      }
    }
  });

  // Croissance des Utilisateurs
  const growthCtx = document.getElementById('userGrowthChart').getContext('2d');
  const growthData = <%= raw @user_growth.to_json %>;
  
  new Chart(growthCtx, {
    type: 'line',
    data: {
      labels: growthData.map(d => d.month),
      datasets: [
        {
          label: 'Total Utilisateurs',
          data: growthData.map(d => d.total_users),
          borderColor: 'rgb(147, 51, 234)',
          backgroundColor: 'rgba(147, 51, 234, 0.1)',
          tension: 0.4,
          fill: true
        },
        {
          label: 'Total Subscribers',
          data: growthData.map(d => d.total_subscribers),
          borderColor: 'rgb(16, 185, 129)',
          backgroundColor: 'rgba(16, 185, 129, 0.1)',
          tension: 0.4,
          fill: true
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          beginAtZero: true
        }
      }
    }
  });
  
  // Am√©lioration de la Heatmap des Interactions
  console.log('üî• Initialisation de la heatmap interactive...');
  
  // R√©cup√©rer toutes les cellules de la heatmap
  const heatmapCells = document.querySelectorAll('[title*="interactions"]');
  console.log(`üìä ${heatmapCells.length} cellules de heatmap trouv√©es`);
  
  // Ajouter des √©v√©nements interactifs √† chaque cellule
  heatmapCells.forEach(cell => {
    const title = cell.getAttribute('title');
    const count = parseInt(title.match(/(\d+) interactions/)?.[1] || '0');
    
    // Am√©liorer l'apparence au survol
    cell.addEventListener('mouseenter', function() {
      if (count > 0) {
        this.style.transform = 'scale(1.05)';
        this.style.zIndex = '10';
        this.style.boxShadow = '0 4px 12px rgba(59, 130, 246, 0.3)';
      }
    });
    
    cell.addEventListener('mouseleave', function() {
      this.style.transform = 'scale(1)';
      this.style.zIndex = 'auto';
      this.style.boxShadow = 'none';
    });
    
    // Ajouter un clic pour afficher plus d'informations
    cell.addEventListener('click', function() {
      if (count > 0) {
        // Cr√©er une tooltip personnalis√©e
        showHeatmapTooltip(this, title, count);
      }
    });
  });
  
  // Fonction pour afficher une tooltip personnalis√©e
  function showHeatmapTooltip(element, title, count) {
    // Supprimer les tooltips existants
    const existingTooltip = document.querySelector('.heatmap-tooltip');
    if (existingTooltip) {
      existingTooltip.remove();
    }
    
    // Cr√©er la tooltip
    const tooltip = document.createElement('div');
    tooltip.className = 'heatmap-tooltip fixed z-50 bg-gray-900 text-white text-sm px-3 py-2 rounded-lg shadow-lg pointer-events-none';
    tooltip.innerHTML = `
      <div class="font-medium">${title}</div>
      <div class="text-blue-300">${count} interaction${count > 1 ? 's' : ''}</div>
    `;
    
    // Positionner la tooltip
    const rect = element.getBoundingClientRect();
    tooltip.style.left = (rect.left + rect.width / 2) + 'px';
    tooltip.style.top = (rect.top - 10) + 'px';
    tooltip.style.transform = 'translateX(-50%) translateY(-100%)';
    
    // Ajouter au DOM
    document.body.appendChild(tooltip);
    
    // Supprimer apr√®s 3 secondes
    setTimeout(() => {
      if (tooltip.parentNode) {
        tooltip.remove();
      }
    }, 3000);
  }
  
  console.log('‚úÖ Heatmap interactive initialis√©e');
});
</script>
