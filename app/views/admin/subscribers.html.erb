<div class="min-h-screen bg-gray-50 py-8">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <!-- Header -->
    <div class="mb-8">
      <h1 class="text-3xl font-bold text-gray-900">Subscribers</h1>
      <p class="mt-2 text-gray-600">Liste des emails capturés et leurs interactions</p>
    </div>

    <!-- Navigation Admin -->
    <div class="mb-8">
      <nav class="flex space-x-4">
        <%= link_to "Dashboard", admin_dashboard_path, class: "px-3 py-2 rounded-md text-sm font-medium text-gray-700 hover:text-gray-900 hover:bg-gray-100" %>
        <%= link_to "Logs", admin_logs_path, class: "px-3 py-2 rounded-md text-sm font-medium text-gray-700 hover:text-gray-900 hover:bg-gray-100" %>
        <%= link_to "Subscribers", admin_subscribers_path, class: "px-3 py-2 rounded-md text-sm font-medium bg-indigo-100 text-indigo-700" %>
        <%= link_to "Users", admin_users_path, class: "px-3 py-2 rounded-md text-sm font-medium text-gray-700 hover:text-gray-900 hover:bg-gray-100" %>
        <%= link_to "Analytics", admin_analytics_path, class: "px-3 py-2 rounded-md text-sm font-medium text-gray-700 hover:text-gray-900 hover:bg-gray-100" %>
        <%= link_to "Export Data", admin_export_data_path, class: "px-3 py-2 rounded-md text-sm font-medium text-gray-700 hover:text-gray-900 hover:bg-gray-100" %>
      </nav>
    </div>

    <!-- Export Buttons -->
    <div class="mb-6 flex justify-between items-center">
      <div class="flex space-x-3">
        <%= link_to "Export CSV", admin_subscribers_path(format: :csv), class: "inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50" %>
        <%= link_to "Export JSON", admin_subscribers_path(format: :json), class: "inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50" %>
      </div>
      <div class="text-sm text-gray-500">
        Total: <%= @subscribers.count %> subscribers
      </div>
    </div>

    <!-- Subscribers Accordions -->
    <div class="space-y-4">
      <% @subscribers.each_with_index do |subscriber, index| %>
        <div class="bg-white shadow rounded-lg overflow-hidden">
          <!-- Accordion Header -->
          <button class="w-full px-6 py-4 text-left hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-inset" 
                  onclick="toggleAccordion('subscriber-<%= index %>')"
                  aria-expanded="false"
                  aria-controls="subscriber-content-<%= index %>">
            <div class="flex items-center justify-between">
              <div class="flex items-center space-x-3">
                <div class="flex-shrink-0">
                  <div class="h-10 w-10 rounded-full bg-blue-100 flex items-center justify-center">
                    <svg class="h-5 w-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                    </svg>
                  </div>
                </div>
                <div class="flex-1 min-w-0">
                  <p class="text-sm font-medium text-gray-900"><%= subscriber.email %></p>
                  <p class="text-sm text-gray-500">
                    Context: <%= subscriber.context || 'N/A' %>
                  </p>
                </div>
              </div>
              <div class="flex items-center space-x-4">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                  <%= subscriber.interaction_count %> interactions
                </span>
                <svg id="subscriber-<%= index %>-icon" class="h-5 w-5 text-gray-400 transform transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
              </div>
            </div>
          </button>
          
          <!-- Accordion Content -->
          <div id="subscriber-content-<%= index %>" class="hidden px-6 pb-4 border-t border-gray-200">
            <div class="mt-4 space-y-4">
              <!-- Basic Info -->
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <h4 class="text-sm font-medium text-gray-700 mb-2">Informations de base</h4>
                  <div class="space-y-2 text-sm text-gray-600">
                    <p><strong>Email:</strong> <%= subscriber.email %></p>
                    <p><strong>Context:</strong> <%= subscriber.context || 'Non spécifié' %></p>
                    <p><strong>Créé le:</strong> <%= subscriber.created_at.strftime("%d/%m/%Y à %H:%M") %></p>
                    <p><strong>Dernière mise à jour:</strong> <%= subscriber.updated_at.strftime("%d/%m/%Y à %H:%M") %></p>
                  </div>
                </div>
                
                <div>
                  <h4 class="text-sm font-medium text-gray-700 mb-2">Engagement</h4>
                  <div class="space-y-2 text-sm text-gray-600">
                    <p><strong>Interactions:</strong> <%= subscriber.interaction_count %></p>
                    <p><strong>Niveau d'engagement:</strong> 
                      <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium 
                        <%= case subscriber.engagement_level
                            when 'new' then 'bg-green-100 text-green-800'
                            when 'engaged' then 'bg-yellow-100 text-yellow-800'
                            when 'very_engaged' then 'bg-orange-100 text-orange-800'
                            when 'super_engaged' then 'bg-red-100 text-red-800'
                            else 'bg-gray-100 text-gray-800'
                            end %>">
                        <%= subscriber.engagement_level.humanize %>
                      </span>
                    </p>
                    <% if subscriber.tone_chips.present? %>
                      <p><strong>Tone chips:</strong></p>
                      <div class="flex flex-wrap gap-1 mt-1">
                        <% subscriber.tone_chips.split(', ').each do |tone| %>
                          <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-purple-100 text-purple-800">
                            <%= tone.strip %>
                          </span>
                        <% end %>
                      </div>
                    <% end %>
                  </div>
                </div>
              </div>
              
              <!-- AI Response -->
              <% if subscriber.ai_response.present? %>
                <div>
                  <h4 class="text-sm font-medium text-gray-700 mb-2">Suggestion AI</h4>
                  <div class="bg-gray-50 p-3 rounded border text-sm text-gray-600 max-h-32 overflow-y-auto">
                    <%= subscriber.ai_response %>
                  </div>
                </div>
              <% end %>
              
              <!-- Recommended Books -->
              <% if subscriber.parsed_response.present? %>
                <% begin %>
                  <% parsed = JSON.parse(subscriber.parsed_response) %>
                  <% if parsed['picks']&.any? %>
                    <div>
                      <h4 class="text-sm font-medium text-gray-700 mb-2">Livres recommandés (<%= parsed['picks'].count %>)</h4>
                      <div class="space-y-3">
                        <% parsed['picks'].each do |pick| %>
                          <div class="bg-blue-50 p-3 rounded border">
                            <div class="flex items-start justify-between">
                              <div class="flex-1">
                                <h5 class="font-medium text-gray-900"><%= pick['title'] %></h5>
                                <p class="text-sm text-gray-600">par <%= pick['author'] %></p>
                                <% if pick['pitch'].present? %>
                                  <p class="text-sm text-gray-600 mt-1"><%= pick['pitch'] %></p>
                                <% end %>
                                <% if pick['why'].present? %>
                                  <p class="text-xs text-gray-500 mt-1"><strong>Pourquoi:</strong> <%= pick['why'] %></p>
                                <% end %>
                              </div>
                              <div class="text-right">
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium 
                                  <%= case pick['confidence']&.downcase
                                      when 'high' then 'bg-green-100 text-green-800'
                                      when 'medium' then 'bg-yellow-100 text-yellow-800'
                                      when 'low' then 'bg-red-100 text-red-800'
                                      else 'bg-gray-100 text-gray-800'
                                      end %>">
                                  <%= pick['confidence'] || 'N/A' %>
                                </span>
                              </div>
                            </div>
                          </div>
                        <% end %>
                      </div>
                    </div>
                  <% end %>
                <% rescue JSON::ParserError %>
                  <div class="text-sm text-red-600">Erreur lors du parsing de la réponse JSON</div>
                <% end %>
              <% end %>
              
              <!-- Session Info -->
              <% if subscriber.session_id.present? %>
                <div>
                  <h4 class="text-sm font-medium text-gray-700 mb-2">Session</h4>
                  <p class="text-sm text-gray-600">ID: <%= subscriber.session_id %></p>
                </div>
              <% end %>
            </div>
          </div>
        </div>
      <% end %>
    </div>

    <!-- Pagination Info -->
    <div class="mt-6 text-center text-sm text-gray-500">
      Affichage des 100 derniers subscribers
    </div>
  </div>
</div>

<!-- JavaScript pour les accordéons -->
<script>
function toggleAccordion(id) {
  const content = document.getElementById('subscriber-content-' + id.split('-')[1]);
  const icon = document.getElementById(id + '-icon');
  
  if (content.classList.contains('hidden')) {
    // Ouvrir l'accordéon
    content.classList.remove('hidden');
    icon.style.transform = 'rotate(180deg)';
  } else {
    // Fermer l'accordéon
    content.classList.add('hidden');
    icon.style.transform = 'rotate(0deg)';
  }
}
</script>
