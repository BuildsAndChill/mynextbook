<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tes recommandations de livres</title>
  <style>
    /* Styles inline pour compatibilit√© email - DESIGN SLEEK comme l'app */
    .container { max-width: 600px; margin: 0 auto; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background-color: #f7fafc; }
    
    /* Header avec couleurs solides (pas de gradient complexe) */
    .header { background-color: #667eea; padding: 30px; text-align: center; color: white; border-radius: 8px 8px 0 0; margin-bottom: 0; }
    .header h1 { margin: 0; font-size: 24px; font-weight: bold; }
    .header p { margin: 10px 0 0 0; font-size: 16px; font-weight: normal; }
    
    /* Content avec espacement g√©n√©reux */
    .content { padding: 40px 30px; background: #ffffff; }
    
    /* Context box √©l√©gant */
    .context-box { background: #f8fafc; border-left: 4px solid #667eea; padding: 24px; margin-bottom: 32px; border-radius: 0 12px 12px 0; }
    .context-box p { margin: 0; font-size: 16px; color: #4a5568; font-style: italic; line-height: 1.5; }
    
    /* Explanation avec typographie soign√©e */
    .explanation { font-size: 16px; color: #2d3748; margin-bottom: 32px; line-height: 1.6; font-weight: 400; }
    
    /* What you tend to like - Section sleek */
    .likes-section { margin-bottom: 32px; background: #ffffff; border: 1px solid #e2e8f0; border-radius: 16px; padding: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
    .likes-title { font-size: 15px; font-weight: 600; color: #059669; margin-bottom: 16px; display: flex; align-items: center; }
    .likes-icon { width: 18px; height: 18px; margin-right: 10px; fill: currentColor; }
    .likes-list { list-style: none; padding: 0; margin: 0; }
    .likes-item { font-size: 14px; color: #374151; margin-bottom: 8px; display: flex; align-items: flex-start; line-height: 1.4; }
    .likes-bullet { width: 6px; height: 6px; background: #10b981; border-radius: 50%; margin-top: 6px; margin-right: 12px; flex-shrink: 0; }
    
    /* Stats barre moderne */
    .stats-bar { background: #ffffff; border: 1px solid #e2e8f0; border-radius: 16px; padding: 20px; margin-bottom: 32px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
    .stats-content { display: flex; justify-content: space-between; align-items: center; }
    .stats-left { font-size: 15px; font-weight: 600; color: #374151; }
    .stats-right { font-size: 14px; color: #6b7280; font-weight: 500; }
    
    /* Book cards - DESIGN SLEEK comme l'app */
    .book { background: #ffffff; border: 1px solid #e2e8f0; border-radius: 16px; padding: 24px; margin-bottom: 24px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
    .book-header { display: flex; align-items: flex-start; gap: 20px; margin-bottom: 20px; }
    
    /* Book cover avec ombre subtile */
    .book-cover { width: 72px; height: 90px; object-fit: cover; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    .book-cover-fallback { width: 72px; height: 90px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 18px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    
    /* Book info avec typographie hi√©rarchis√©e */
    .book-info { flex: 1; min-width: 0; }
    .book-title { font-size: 20px; font-weight: 700; color: #111827; margin: 0 0 6px 0; line-height: 1.3; letter-spacing: -0.025em; }
    .book-author { font-size: 15px; color: #667eea; margin-bottom: 16px; font-weight: 600; }
    
    /* Rating stars avec design moderne */
    .rating { display: flex; align-items: center; margin-bottom: 16px; }
    .star { width: 18px; height: 18px; margin-right: 3px; }
    .star-filled { fill: #fbbf24; }
    .star-empty { fill: #e5e7eb; }
    .rating-text { margin-left: 10px; font-size: 15px; font-weight: 600; color: #374151; }
    .rating-count { margin-left: 8px; font-size: 13px; color: #6b7280; font-weight: 500; }
    
    /* Metadata tags avec design sleek */
    .metadata { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 16px; }
    .metadata-tag { background: #f3f4f6; color: #4b5563; padding: 6px 12px; border-radius: 8px; font-size: 12px; font-weight: 500; border: 1px solid #e5e7eb; }
    
    /* Book description avec typographie soign√©e */
    .book-description { font-size: 14px; color: #4b5563; line-height: 1.6; margin-bottom: 16px; font-weight: 400; }
    .book-pitch { font-size: 14px; color: #374151; margin-bottom: 12px; font-weight: 500; line-height: 1.5; }
    .book-why { font-size: 13px; color: #6b7280; margin-bottom: 20px; line-height: 1.4; }
    
    /* Confidence badge avec design moderne */
    .confidence { display: inline-flex; align-items: center; padding: 6px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.025em; }
    .confidence-high { background: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
    .confidence-medium { background: #fef3c7; color: #92400e; border: 1px solid #fde68a; }
    .confidence-low { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }
    
    /* Action buttons - Design Gmail-compatible */
    .book-actions { border-top: 1px solid #e5e7eb; padding-top: 18px; text-align: center; }
    .btn { padding: 10px 18px; border-radius: 6px; text-decoration: none; font-size: 14px; font-weight: bold; margin: 0 8px 8px 0; display: inline-block; }
    .btn-primary { background-color: #667eea; color: white; border: 1px solid #5a67d8; }
    .btn-secondary { background-color: #ffffff; color: #4b5563; border: 1px solid #e5e7eb; }
    
    /* Call to action simple */
    .cta-section { background-color: #667eea; padding: 25px; border-radius: 8px; text-align: center; margin-top: 25px; }
    .cta-title { color: white; margin: 0 0 10px 0; font-size: 18px; font-weight: bold; }
    .cta-text { color: white; margin: 0 0 20px 0; font-size: 16px; line-height: 1.5; font-weight: normal; }
    .cta-btn { background-color: white; color: #667eea; font-weight: bold; text-decoration: none; padding: 12px 24px; border-radius: 6px; display: inline-block; border: 1px solid #e5e7eb; }
    
    /* Footer avec design moderne */
    .footer { background: #f8fafc; padding: 40px 30px; text-align: center; color: #6b7280; border-radius: 0 0 16px 16px; border-top: 1px solid #e2e8f0; }
    .footer a { color: #667eea; text-decoration: none; font-weight: 500; }
    .footer .unsubscribe { margin-top: 24px; font-size: 12px; }
    
    /* Responsive design */
    @media (max-width: 600px) {
      .container { margin: 0; }
      .header, .content, .footer { padding: 24px 20px; }
      .book-header { flex-direction: column; align-items: center; text-align: center; }
      .book-cover, .book-cover-fallback { width: 80px; height: 100px; }
      .btn { display: block; width: 100%; margin-right: 0; margin-bottom: 12px; }
      .metadata { justify-content: center; }
    }
  </style>
</head>
<body style="margin: 0; padding: 0; background-color: #f7fafc;">
  <div class="container">
    <!-- Header -->
    <div class="header">
      <h1>üìö Tes Recommandations</h1>
      <p>D√©couvertes personnalis√©es pour toi</p>
    </div>

    <!-- Content -->
    <div class="content">
      <!-- Context -->
      <% if @context.present? %>
        <div class="context-box">
          <p><strong>Ta demande :</strong> "<%= @context %>"</p>
        </div>
      <% end %>

      <!-- Stats Bar - m√™me style que la page -->
      <div class="stats-bar">
        <div class="stats-content">
          <div class="stats-left">
            <% if @books.any? %>
              <%= pluralize(@books.count, 'book') %> for you
            <% end %>
          </div>
          <div class="stats-right">
            <% if @books.any? %>
              <%= @books.count %> found
            <% end %>
          </div>
        </div>
      </div>

      <!-- Explanation -->
      <div class="explanation">
        <%= simple_format(@explanation) %>
      </div>

      <!-- What you tend to like - Section avec les 3 bullets verts -->
      <% if @recommendations&.dig(:brief, :likes)&.any? %>
        <div class="likes-section">
          <h4 class="likes-title">
            <svg class="likes-icon" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
            </svg>
            What you tend to like
          </h4>
          <div class="likes-list">
            <% @recommendations[:brief][:likes].each do |point| %>
              <div class="likes-item">
                <span class="likes-bullet"></span>
                <%= point %>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>

      <!-- Books - m√™me design que la page -->
      <% @books.each_with_index do |book, index| %>
                 <div class="book">
           <div class="book-header">
             <!-- Book Cover -->
             <% if book[:cover_url].present? || book['cover_url'].present? %>
               <img src="<%= book[:cover_url] || book['cover_url'] %>" 
                    alt="<%= book[:title] || book['title'] %>" 
                    class="book-cover"
                    onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
             <% end %>
             
             <!-- Fallback Cover -->
             <div class="book-cover-fallback" style="display: <%= (book[:cover_url].present? || book['cover_url'].present?) ? 'none' : 'block' %>;">
               <%= (book[:title] || book['title']).to_s.split(' ').map(&:first).join('').upcase[0..1] %>
             </div>
             
             <div class="book-info">
              <h3 class="book-title"><%= index + 1 %>. <%= book[:title] || book['title'] %></h3>
              <div class="book-author">by <%= book[:author] || book['author'] %></div>
              
              <!-- Rating Display -->
              <% if book[:rating].present? || book['rating'].present? %>
                <div class="rating">
                  <% rating_value = (book[:rating] || book['rating']).to_f %>
                  <% full_stars = rating_value.floor %>
                  <% has_half_star = (rating_value % 1) != 0 %>
                  
                  <!-- Full stars -->
                  <% full_stars.times do %>
                    <svg class="star star-filled" viewBox="0 0 20 20">
                      <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                    </svg>
                  <% end %>
                  
                  <!-- Half star -->
                  <% if has_half_star %>
                    <svg class="star star-filled" viewBox="0 0 20 20">
                      <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                    </svg>
                  <% end %>
                  
                  <!-- Empty stars -->
                  <% empty_stars = 5 - full_stars - (has_half_star ? 1 : 0) %>
                  <% empty_stars.times do %>
                    <svg class="star star-empty" viewBox="0 0 20 20">
                      <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                    </svg>
                  <% end %>
                  
                  <span class="rating-text"><%= rating_value %>/5</span>
                  <% if book[:review_count].present? || book['review_count'].present? %>
                    <span class="rating-count">(<%= book[:review_count] || book['review_count'] %> reviews)</span>
                  <% end %>
                </div>
              <% end %>
              
              <!-- Additional Metadata -->
              <% if book[:page_count].present? || book['page_count'].present? || book[:published_date].present? || book['published_date'].present? || book[:categories].present? || book['categories'].present? %>
                <div class="metadata">
                  <% if book[:page_count].present? || book['page_count'].present? %>
                    <span class="metadata-tag"><%= book[:page_count] || book['page_count'] %> pages</span>
                  <% end %>
                  <% if book[:published_date].present? || book['published_date'].present? %>
                    <span class="metadata-tag"><%= book[:published_date] || book['published_date'] %></span>
                  <% end %>
                  <% if book[:categories].present? || book['categories'].present? %>
                    <span class="metadata-tag"><%= book[:categories] || book['categories'] %></span>
                  <% end %>
                  <% if book[:genre].present? || book['genre'].present? %>
                    <span class="metadata-tag"><%= book[:genre] || book['genre'] %></span>
                  <% end %>
                </div>
              <% end %>
              
              <!-- Book Description -->
              <% if book[:description].present? || book['description'].present? %>
                <div class="book-description">
                  <%= truncate(book[:description] || book['description'], length: 200) %>
                </div>
              <% end %>
              
              <!-- Book Pitch -->
              <% if book[:pitch].present? || book['pitch'].present? %>
                <div class="book-pitch"><%= book[:pitch] || book['pitch'] %></div>
              <% end %>
              
              <!-- Why this pick -->
              <% if book[:why].present? || book['why'].present? %>
                <div class="book-why"><strong>Why this pick:</strong> <%= book[:why] || book['why'] %></div>
              <% end %>
              
              <!-- Confidence Meter -->
              <% if book[:confidence].present? || book['confidence'].present? %>
                <div class="confidence <%= case (book[:confidence] || book['confidence'])&.downcase
                    when 'high' then 'confidence-high'
                    when 'medium' then 'confidence-medium'
                    when 'low' then 'confidence-low'
                    else 'confidence-medium'
                    end %>">
                  <%= book[:confidence] || book['confidence'] || 'Medium' %>
                </div>
              <% end %>
            </div>
          </div>
          
                     <!-- Action Buttons -->
           <div class="book-actions">
             <% if book[:direct_link].present? || book['direct_link'].present? %>
               <a href="<%= book[:direct_link] || book['direct_link'] %>" class="btn btn-primary" target="_blank" style="text-decoration: none; color: white; background-color: #667eea; padding: 10px 18px; border-radius: 6px; border: 1px solid #5a67d8; margin: 0 8px 8px 0; display: inline-block; font-weight: bold;">
                 üîç Voir plus
               </a>
             <% elsif book[:search_url].present? || book['search_url'].present? %>
               <a href="<%= book[:search_url] || book['search_url'] %>" class="btn btn-primary" target="_blank" style="text-decoration: none; color: white; background-color: #667eea; padding: 10px 18px; border-radius: 6px; border: 1px solid #5a67d8; margin: 0 8px 8px 0; display: inline-block; font-weight: bold;">
                 üîç Voir sur Goodreads
               </a>
             <% end %>
             <a href="https://www.google.com/search?q=<%= CGI.escape("#{book[:title] || book['title']} #{book[:author] || book['author']} livre") %>" class="btn btn-secondary" target="_blank" style="text-decoration: none; color: #4b5563; background-color: #ffffff; padding: 10px 18px; border-radius: 6px; border: 1px solid #e5e7eb; margin: 0 8px 8px 0; display: inline-block; font-weight: bold;">
               üìñ Rechercher
               </a>
           </div>
        </div>
      <% end %>

      <!-- Call to Action -->
      <div class="cta-section">
        <h3 class="cta-title">Envie de plus de recommandations ?</h3>
        <p class="cta-text">
          Retourne sur MyNextBook pour affiner tes go√ªts et d√©couvrir encore plus de livres parfaits pour toi.
        </p>
        <a href="<%= root_url %>" class="cta-btn">
          üöÄ D√©couvrir plus de livres
        </a>
      </div>
    </div>

    <!-- Footer -->
    <div class="footer">
      <p>
        <strong>MyNextBook</strong><br>
        Tes prochaines lectures, personnalis√©es par IA
      </p>
      
      <p style="margin-top: 20px;">
        <a href="<%= root_url %>">üè† Accueil</a> ‚Ä¢
        <a href="<%= root_url %>">üìö Nouvelles recommandations</a> ‚Ä¢
        <a href="mailto:contact@mynextbook.com">‚úâÔ∏è Contact</a>
      </p>

      <div class="unsubscribe">
        <p>
          Tu ne veux plus recevoir ces emails ?<br>
          <a href="<%= root_url %>unsubscribe?token=<%= @unsubscribe_token %>&email=<%= CGI.escape(@subscriber.email) %>">
            Se d√©sabonner
          </a>
        </p>
      </div>
    </div>
  </div>
</body>
</html>
